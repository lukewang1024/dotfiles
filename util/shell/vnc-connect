#!/usr/bin/env bash

print_usage() {
  cat << 'EOB' >&2
Connect to VNC server securely by SSH tunnel.
[Synopsis]
vnc-connect [host] [display]
[host]
Required, host alias configured in `~/.ssh/config`.
[display]
Optional, display number (1, 2, etc.) or :1, :2, etc. Default is 1.
EOB
  exit 1
}

if [ $# -eq 0 ]; then
  print_usage
fi

config_dir="$HOME/.dotfiles/config"
source "$config_dir/utils.sh";

HOST=$1
DISPLAY_ARG=${2:-1}

# Strip leading colon if present
DISPLAY_NUM=${DISPLAY_ARG#:}

# Calculate ports
REMOTE_PORT=$((DISPLAY_NUM + 5900))
LOCAL_PORT=$((DISPLAY_NUM + 15900))

# Check if tunnel already exists
if lsof -i :$LOCAL_PORT > /dev/null 2>&1; then
  echo "Tunnel already exists on port $LOCAL_PORT"
else
  echo "Creating SSH tunnel: localhost:$LOCAL_PORT -> $HOST:$REMOTE_PORT"
  ssh -N -f -L $LOCAL_PORT:localhost:$REMOTE_PORT $HOST
  if [ $? -eq 0 ]; then
    echo "Tunnel established successfully"
  else
    echo "Failed to create SSH tunnel"
    exit 1
  fi
fi

# Open VNC connection
if is_macos; then
  open vnc://localhost:$LOCAL_PORT
elif exists vncviewer; then
  vncviewer localhost:$LOCAL_PORT
else
  echo "VNC viewer not found. Connect manually to localhost:$LOCAL_PORT"
fi
